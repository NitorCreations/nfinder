<!DOCTYPE html>
<html>

<head></head>

<body>
    <button id="get-access">Activate camera</button>
    <video autoplay playsinline></video>
    <button id="takePhoto">Take photo</button>
    <img id="imitsi"></img>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script type="module" src="/imagecapture.js">
    </script>

    <h1 id="photoheader"></h1>
    <div id="photocontainer"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js'
        // Add Firebase products that you want to use
        import { getFirestore, collection, getDocs, getDoc, onSnapshot, doc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js'
        import { getAuth, getRedirectResult, signInWithCredential, signInWithPopup, signInWithRedirect, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js'

        var track;

        document.querySelector('#get-access').addEventListener('click', async function init(e) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: true
                })
                const videoTracks = stream.getVideoTracks()
                track = videoTracks[0]
                //alert(`Getting video from: ${track.label}`)
                document.querySelector('video').srcObject = stream
                //document.querySelector('#get-access').setAttribute('hidden', true)
                //The video stream is stopped by track.stop() after 30 seconds of playback.
                setTimeout(() => { track.stop() }, 30 * 1000)
            } catch (error) {
                alert(`${error.name}`)
                console.error(error)
            }
        })

        var takePhotoButton = document.querySelector('button#takePhoto');
        var img = document.querySelector('#imitsi');

        takePhotoButton.onclick = takePhoto;

        // Get a Blob from the currently selected camera source and
        // display this with an img element.
        function takePhoto() {
            var imageCapture = new window.ImageCapture(track);
            imageCapture.takePhoto().then(function (blob) {
                img.classList.remove('hidden');
                img.src = URL.createObjectURL(blob);
                submitPhoto(blob);
            }).catch(function (error) {
                console.log('takePhoto() error: ', error);
            });
        }

        async function submitPhoto(blob) {
            let response = await fetch(getPresignedUrlEndpoint + `?contentType=${blob.type}`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                }
            });
            let presignedData = await response.json();
            console.log(presignedData);

            fetch(presignedData.imagePostUrl, {
                method: "PUT",
                headers: {},
                body: blob,
            }).then(res => {
                console.log("Request complete! response:", res);
            });

        }

        // TODO load these details from bucket where they are written to by terraform
        const firebaseConfig = {
            apiKey: "AIzaSyB5cpT3kTay1x60tdOd4C6_sxRyLlIEX-I",
            authDomain: "nfinder-1.firebaseapp.com",
            projectId: "nfinder-1",
            storageBucket: "nfinder-1.appspot.com",
            messagingSenderId: "278244435575",
            appId: "1:278244435575:web:7c41fb6b45413a3fd60872"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        const keyword = parseKeywordFromPath();
        const getPresignedUrlEndpoint = `https://g1nhbctnde.execute-api.eu-west-1.amazonaws.com/get-presigned-url-s3/${keyword}`;

        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            const auth = getAuth(firebaseApp);
            var credential = GoogleAuthProvider.credential(response.credential);
            signInWithCredential(auth, credential)
                .then(async (firebaseCredential) => {
                    // Signed in
                    var user = firebaseCredential.user;
                    console.log('we have firebase credentials');
                    console.log(user);
                    const firestore = getFirestore(firebaseApp);
                    const unsubFirestore = await loadImages(firestore);
                })
                .catch((error) => {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    console.log('errorii');
                    console.error(error);
                });

        }
        let accessToken;
        const provider = new GoogleAuthProvider();
        const auth = getAuth(firebaseApp);
        auth.onAuthStateChanged(async user => {
            if (user) {
                // User just signed in, we should not display dialog next time because of firebase auto-login
                localStorage.setItem('nFinder.signedIn', '1');
                console.log('auth state changed to logged in');
                accessToken = user.accessToken;
                console.log(user);
                const firestore = getFirestore(firebaseApp);
                const unsubFirestore = await loadImages(firestore, keyword);
            } else {
                // User just signed-out or auto-login failed, we will show sign-in form immediately the next time he loads the page
                console.log('auth state changed to logged out');
                localStorage.removeItem('nFinder.signedIn');
                login();
            }
        });
        console.log('current user: ' + auth.currentUser);

        window.onload = async function () {
            const photoHeader = document.querySelector('#photoheader');
            photoHeader.textContent = `Scoreboard for "${parseKeywordFromPath()}"`;

            getRedirectResult(auth).then(async function (result) {
                // The signed-in user info.
                if (result && result.user) {
                    var user = result.user;
                    accessToken = user.accessToken;
                    localStorage.setItem('nFinder.signedIn', '1');
                }
            }).catch(function (error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                // The email of the user's account used.
                var email = error.email;
                // The firebase.auth.AuthCredential type that was used.
                var credential = error.credential;
                if (errorCode === 'auth/account-exists-with-different-credential') {
                    alert('You have already signed up with a different auth provider for that email.');
                    // If you are using multiple auth providers on your app you should handle linking
                    // the user's accounts here.
                } else {
                    console.error(error);
                }
            });
        }

        function login() {
            signInWithRedirect(auth, provider);
        }

        async function loadImages(firestore, keyword) {
            const q = query(collection(firestore, keyword), orderBy("score", "desc"));
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const images = [];
                querySnapshot.forEach((doc) => {
                    images.push(doc.data());
                });
                renderImages(images);
            });
            return unsubscribe;
        }

        function renderImages(images) {
            const container = document.querySelector('#photocontainer');
            container.textContent = '';
            images.forEach((image) => {
                // create a new div element
                const newDiv = document.createElement("div");

                // and give it some content
                const imageElement = document.createElement('img');
                imageElement.src = image.imageUrl;
                const scoreElement = document.createElement('div')
                scoreElement.appendChild(document.createTextNode(`Score: ${image.score}`));
                const captionElement = document.createElement('div')
                captionElement.appendChild(document.createTextNode(`"${image.caption}"`));

                newDiv.appendChild(imageElement);
                newDiv.appendChild(scoreElement);
                newDiv.appendChild(captionElement);
                container.appendChild(newDiv);
            });

        }

        function parseKeywordFromPath() {
            const match = window.location.href.match(/.*\/(.*)/)
            const keyword = match.length > 1 ? match[1] : 'goat';
            console.log(`keyword: ${keyword}`);
            return keyword;
        }
    </script>

</body>

</html>