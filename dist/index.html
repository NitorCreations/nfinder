<!DOCTYPE html>
<html>

<head></head>

<body>
    <button id="get-access">Get access to camera</button>
    <video autoplay></video>
    <button id="takePhoto">Take photo</button>
    <img id="imitsi"></img>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script type="module" src="/imagecapture.js">
    </script>

    <h1 id="photoheader"></h1>
    <div id="photocontainer"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js'
        // Add Firebase products that you want to use
        import { getFirestore, collection, getDocs, getDoc, onSnapshot, doc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js'
        import { getAuth, signInWithCredential, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js'

        var track;

        document.querySelector('#get-access').addEventListener('click', async function init(e) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: true
                })
                const videoTracks = stream.getVideoTracks()
                track = videoTracks[0]
                //alert(`Getting video from: ${track.label}`)
                document.querySelector('video').srcObject = stream
                document.querySelector('#get-access').setAttribute('hidden', true)
                //The video stream is stopped by track.stop() after 3 second of playback.
                setTimeout(() => { track.stop() }, 3 * 1000)
            } catch (error) {
                alert(`${error.name}`)
                console.error(error)
            }
        })

        var takePhotoButton = document.querySelector('button#takePhoto');
        var img = document.querySelector('#imitsi');

        takePhotoButton.onclick = takePhoto;

        // Get a Blob from the currently selected camera source and
        // display this with an img element.
        function takePhoto() {
            var imageCapture = new window.ImageCapture(track);
            imageCapture.takePhoto().then(function (blob) {
                console.log('Took photo:', blob);
                img.classList.remove('hidden');
                img.src = URL.createObjectURL(blob);
            }).catch(function (error) {
                console.log('takePhoto() error: ', error);
            });
        }

        // Initialize Firestore through Firebase

        // TODO load these details from bucket where they are written to by terraform
        const firebaseConfig = {
            apiKey: "AIzaSyB5cpT3kTay1x60tdOd4C6_sxRyLlIEX-I",
            authDomain: "nfinder-1.firebaseapp.com",
            projectId: "nfinder-1",
            storageBucket: "nfinder-1.appspot.com",
            messagingSenderId: "278244435575",
            appId: "1:278244435575:web:7c41fb6b45413a3fd60872"
        };
        const firebaseApp = initializeApp(firebaseConfig);
        //const oauthClientId = "997502378708-b0ugr5c1kfsusje8odk7jvbi3f2r9u6q.apps.googleusercontent.com";

        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            const auth = getAuth(firebaseApp);
            var credential = GoogleAuthProvider.credential(response.credential);
            signInWithCredential(auth, credential)
                .then(async (firebaseCredential) => {
                    // Signed in
                    var user = firebaseCredential.user;
                    console.log('we have firebase credentials');
                    console.log(user);
                    const firestore = getFirestore(firebaseApp);
                    const unsubFirestore = await loadImages(firestore);
                })
                .catch((error) => {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    console.log('errorii');
                    console.error(error);
                });

        }
        window.onload = function () {
            const photoHeader = document.querySelector('#photoheader');
            photoHeader.textContent = `Scoreboard for "${parseKeywordFromPath()}"`;
            const provider = new GoogleAuthProvider();
            const auth = getAuth(firebaseApp);
            signInWithPopup(auth, provider)
                .then(async (result) => {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const token = credential.accessToken;
                    // The signed-in user info.
                    const user = result.user;
                    console.log(user.accessToken);
                    // ...
                    const firestore = getFirestore(firebaseApp);
                    const unsubFirestore = await loadImages(firestore);
                }).catch((error) => {
                    console.log(error);
                });
            //    google.accounts.id.initialize({
            //        //TODO load from config dynamically
            //        client_id: oauthClientId,
            //        callback: handleCredentialResponse
            //    });
            //    google.accounts.id.renderButton(
            //        document.getElementById("buttonDiv"),
            //        { theme: "outline", size: "large" }  // customization attributes
            //    );
            //    google.accounts.id.prompt(); // also display the One Tap dialog
        }

        async function loadImages(firestore) {
            const q = query(collection(firestore, "eagle"), orderBy("score", "desc"));
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const images = [];
                querySnapshot.forEach((doc) => {
                    images.push(doc.data());
                });
                renderImages(images);
            });
            return unsubscribe;
        }

        function renderImages(images) {
            const container = document.querySelector('#photocontainer');
            container.textContent = '';
            images.forEach((image) => {
                // create a new div element
                const newDiv = document.createElement("div");

                // and give it some content
                const imageElement = document.createElement('img');
                imageElement.src = image.imageUrl;
                const scoreElement = document.createElement('div')
                scoreElement.appendChild(document.createTextNode(`Score: ${image.score}`));
                const captionElement = document.createElement('div')
                captionElement.appendChild(document.createTextNode(`"${image.caption}"`));

                newDiv.appendChild(imageElement);
                newDiv.appendChild(scoreElement);
                newDiv.appendChild(captionElement);
                container.appendChild(newDiv);
            });

        }

        function parseKeywordFromPath() {
            const match = window.location.href.match(/.*\/(.*)/)
            const keyword = match.length > 1 ? match[1] : 'goat';
            console.log(`keyword: ${keyword}`);
            return keyword
        }
//        const firestore = getFirestore(firebaseApp);
 //       const unsubFirestore = await loadImages(firestore);

    </script>


    <!-- <script src="https://accounts.google.com/gsi/client" async defer></script> -->
    <script>
    </script>
    <div id="buttonDiv"></div>

</body>

</html>