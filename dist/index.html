<!DOCTYPE html>
<html>

<head></head>

<body>
    <button id="get-access">Get access to camera</button>
    <video autoplay></video>
    <button id="takePhoto">Take photo</button>
    <img id="imitsi"></img>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    <script type="module">
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js'
        // Add Firebase products that you want to use
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js'
        import { getAuth, signInWithCredential, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js'

        document.querySelector('#get-access').addEventListener('click', async function init(e) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: true
                })
                const videoTracks = stream.getVideoTracks()
                const track = videoTracks[0]
                alert(`Getting video from: ${track.label}`)
                document.querySelector('video').srcObject = stream
                document.querySelector('#get-access').setAttribute('hidden', true)
                //The video stream is stopped by track.stop() after 3 second of playback.
                setTimeout(() => { track.stop() }, 3 * 1000)
            } catch (error) {
                alert(`${error.name}`)
                console.error(error)
            }
        })

        var takePhotoButton = document.querySelector('button#takePhoto');
        var img = document.querySelector('imitsi');

        takePhotoButton.onclick = takePhoto;

        // Get a Blob from the currently selected camera source and
        // display this with an img element.
        function takePhoto() {
            var imageCapture = new ImageCapture(track);
            imageCapture.takePhoto().then(function (blob) {
                console.log('Took photo:', blob);
                img.classList.remove('hidden');
                img.src = URL.createObjectURL(blob);
            }).catch(function (error) {
                console.log('takePhoto() error: ', error);
            });
        }

        // Initialize Firestore through Firebase

        // TODO load these details from bucket where they are written to by terraform
        const firebaseApp = initializeApp({
            "apiKey": "AIzaSyA5x-moezGP-w3lUf-KrA94OreEcJL03YA",
            "appId": "1:997502378708:web:45dd219f0c46939ab81141",
            "authDomain": "nfinder-12345678.firebaseapp.com",
            "messagingSenderId": "997502378708",
            "storageBucket": "nfinder-12345678.appspot.com",
            "projectId": "nfinder-12345678"
        });
        const oauthClientId = "997502378708-b0ugr5c1kfsusje8odk7jvbi3f2r9u6q.apps.googleusercontent.com";

        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            const auth = getAuth(firebaseApp);
            var credential = GoogleAuthProvider.credential(response.credential);
            signInWithCredential(auth, credential)
                .then((userCredential) => {
                    // Signed in
                    var user = userCredential.user;
                    console.log(user);
                })
                .catch((error) => {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    console.log('errorii');
                    console.error(error);
                });

        }
        window.onload = function () {
            google.accounts.id.initialize({
                //TODO load from config dynamically
                client_id: oauthClientId,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("buttonDiv"),
                { theme: "outline", size: "large" }  // customization attributes
            );
            google.accounts.id.prompt(); // also display the One Tap dialog
        }


        const db = getFirestore();
        const querySnapshot = getDocs(collection(db, "goat")).then(function (snapshot) {
            snapshot.forEach((doc) => {
                console.log(`${doc.id} => ${doc.data()}`);
            });
        });
    </script>


    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
    </script>
    <div id="buttonDiv"></div>
    <!--
    <script type="text/javascript">
        console.log('kee');
        // Enter an API key from the Google API Console:
        //   https://console.developers.google.com/apis/credentials
        var apiKey = 'AIzaSyA5x-moezGP-w3lUf-KrA94OreEcJL03YA';

        // Enter the API Discovery Docs that describes the APIs you want to
        // access. In this example, we are accessing the People API, so we load
        // Discovery Doc found here: https://developers.google.com/people/api/rest/
        var discoveryDocs = ["https://people.googleapis.com/$discovery/rest?version=v1"];

        // Enter a client ID for a web application from the Google API Console:
        //   https://console.developers.google.com/apis/credentials?project=_
        // In your API Console project, add a JavaScript origin that corresponds
        //   to the domain where you will be running the script.
        var clientId = '997502378708-6f1p917ubb0eho4o7r9jbrvimpc2fe0s.apps.googleusercontent.com';

        // Enter one or more authorization scopes. Refer to the documentation for
        // the API or https://developers.google.com/people/v1/how-tos/authorizing
        // for details.
        var scopes = 'profile';

        var authorizeButton = document.getElementById('authorize-button');
        var signoutButton = document.getElementById('signout-button');

        function handleClientLoad() {
            // Load the API client and auth2 library
            gapi.load('client:auth2', initClient);
        }

        function initClient() {
            gapi.client.init({
                apiKey: apiKey,
                discoveryDocs: discoveryDocs,
                clientId: clientId,
                scope: scopes
            }).then(function () {
                console.log('inittehn');
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
            });
        }

        function updateSigninStatus(isSignedIn) {
            console.log('uss');
            console.log(gapi.auth2.getAuthInstance().isSignedIn.get());
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                console.log(gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse(true).access_token);
            } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
            }
        }

        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        // Load the API and make an API call.  Display the results on the screen.
        function makeApiCall() {
            gapi.client.people.people.get({
                'resourceName': 'people/me',
                'requestMask.includeField': 'person.names'
            }).then(function (resp) {
                var p = document.createElement('p');
                var name = resp.result.names[0].givenName;
                p.appendChild(document.createTextNode('Hello, ' + name + '!'));
                document.getElementById('content').appendChild(p);
            });
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>
-->
</body>

</html>